- name: Add MetalLB Helm repository
  kubernetes.core.helm_repository:
    name: metallb
    repo_url: https://metallb.github.io/metallb
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"

- name: Install MetalLB
  kubernetes.core.helm:
    name: metallb
    chart_ref: metallb/metallb
    release_namespace: metallb-system
    create_namespace: true
    chart_version: "{{ metallb_version }}"
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"

- name: Wait for MetalLB controller
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: metallb-controller
    namespace: metallb-system
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: Fix metrics-server configuration for connectivity issues
  kubernetes.core.k8s:
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: metrics-server
        namespace: kube-system
      spec:
        template:
          spec:
            containers:
              - name: metrics-server
                args:
                  - --cert-dir=/tmp
                  - --secure-port=10250
                  - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
                  - --kubelet-use-node-status-port
                  - --metric-resolution=15s
                  - --kubelet-insecure-tls
    merge_type: strategic-merge # Only options available are "strategic-merge" and "merge"

- name: Restart metrics-server pod to apply new configuration
  shell: |
    kubectl rollout restart deployment metrics-server -n kube-system
    kubectl rollout status deployment metrics-server -n kube-system --timeout=120s
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"

- name: Wait for metrics-server to be ready with new configuration
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: metrics-server
    namespace: kube-system
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300
  ignore_errors: true

- name: Create MetalLB IP address pool
  kubernetes.core.k8s:
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"
    definition:
      apiVersion: metallb.io/v1beta1
      kind: IPAddressPool
      metadata:
        name: default-pool
        namespace: metallb-system
      spec:
        addresses:
          - "{{ metallb_address_pool }}"

- name: Create MetalLB L2Advertisement
  kubernetes.core.k8s:
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"
    definition:
      apiVersion: metallb.io/v1beta1
      kind: L2Advertisement
      metadata:
        name: default-advertise
        namespace: metallb-system
      spec:
        ipAddressPools:
          - default-pool
