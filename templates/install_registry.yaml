---
# === Install Docker Registry ===

- name: Create registry namespace
  kubernetes.core.k8s:
    name: "{{ registry_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"

- name: Create registry persistent volume
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: registry-pv
        namespace: "{{ registry_namespace }}"
      spec:
        capacity:
          storage: "{{ registry_storage_size }}"
        accessModes:
          - ReadWriteOnce
        persistentVolumeReclaimPolicy: Retain
        storageClassName: local-storage
        hostPath:
          path: /var/lib/registry
          type: DirectoryOrCreate
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"

- name: Create registry persistent volume claim
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: registry-pvc
        namespace: "{{ registry_namespace }}"
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: "{{ registry_storage_size }}"
        storageClassName: local-storage
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"

- name: Create registry deployment
  kubernetes.core.k8s:
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: registry
        namespace: "{{ registry_namespace }}"
        labels:
          app: registry
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: registry
        template:
          metadata:
            labels:
              app: registry
          spec:
            containers:
              - name: registry
                image: registry:2.8
                ports:
                  - containerPort: 5000
                    protocol: TCP
                env:
                  - name: REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY
                    value: /var/lib/registry
                  - name: REGISTRY_HTTP_ADDR
                    value: 0.0.0.0:5000
                volumeMounts:
                  - name: registry-storage
                    mountPath: /var/lib/registry
                resources:
                  requests:
                    memory: "256Mi"
                    cpu: "100m"
                  limits:
                    memory: "512Mi"
                    cpu: "500m"
            volumes:
              - name: registry-storage
                persistentVolumeClaim:
                  claimName: registry-pvc
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"

- name: Create registry service
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: registry-service
        namespace: "{{ registry_namespace }}"
        labels:
          app: registry
      spec:
        type: LoadBalancer
        loadBalancerIP: "{{ registry_lb_ip }}"
        ports:
          - port: 5000
            targetPort: 5000
            protocol: TCP
            name: registry
        selector:
          app: registry
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"

- name: Create registry ingress
  kubernetes.core.k8s:
    definition:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: registry-ingress
        namespace: "{{ registry_namespace }}"
        annotations:
          cert-manager.io/cluster-issuer: "{{ 'letsencrypt-prod' if tls_mode == 'letsencrypt' else 'selfsigned-issuer' }}"
          traefik.ingress.kubernetes.io/router.tls: "true"
          nginx.ingress.kubernetes.io/proxy-body-size: "0"
          nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
          nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
      spec:
        tls:
          - hosts:
              - "{{ registry_host }}"
            secretName: registry-tls
        rules:
          - host: "{{ registry_host }}"
            http:
              paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: registry-service
                      port:
                        number: 5000
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"

- name: Wait for registry deployment to be ready
  tags: wait_registry_deployment
  kubernetes.core.k8s_info:
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"
    api_version: apps/v1
    kind: Deployment
    name: registry
    namespace: "{{ registry_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: Display registry information
  tags: display_registry_info
  debug:
    msg:
      - "Registry deployed successfully!"
      - "LoadBalancer IP: {{ registry_lb_ip }}"
      - "Registry URL (internal): http://{{ registry_lb_ip }}:5000"
      - "Registry URL (external): https://{{ registry_host }}"
      - "Authentication: Disabled (open access)"
      - ""
      - "To test the registry:"
      - "docker tag my-image:latest {{ registry_lb_ip }}:5000/my-image:latest"
      - "docker push {{ registry_lb_ip }}:5000/my-image:latest"
